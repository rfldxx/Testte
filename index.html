<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Class Demo</title>
</head>
<body>
    <h1>WASM Class Demo</h1>
    
    <div>
        <label for="x">Значение x:</label>
        <input type="number" id="x" value="5">
    </div>
    
    <div>
        <label for="y">Значение y:</label>
        <input type="number" id="y" value="3">
    </div>
    
    <div>
        <button id="calculate">Создать Calc(x) и вызвать методы</button>
    </div>
    
    <div>
        <h3>Результаты:</h3>
        <div>
            <strong>f(y) = x * y:</strong> 
            <span id="result-f">-</span>
        </div>
        <div>
            <strong>g() возвращает строку:</strong> 
            <span id="result-g">-</span>
        </div>
    </div>

    <!-- Загружаем JS обертку от Emscripten -->
    <script src="calc.js"></script>
    <script>
        // Модуль WASM
        let Module = null;
        
        // Инициализация модуля
        function initModule() {
            // Конфигурация модуля Emscripten
            Module = {
                onRuntimeInitialized: function() {
                    console.log('WASM модуль загружен и инициализирован');
                    document.getElementById('calculate').disabled = false;
                },
                print: function(text) {
                    console.log('WASM:', text);
                },
                printErr: function(text) {
                    console.error('WASM error:', text);
                }
            };
            
            // Создаем модуль
            createModule(Module);
        }
        
        // Функция для чтения строк из памяти WASM
        function readAsciiFromMemory(ptr) {
            if (!ptr) return "";
            
            let str = "";
            let memory = new Uint8Array(Module.HEAPU8.buffer);
            let i = ptr;
            
            while (memory[i] !== 0) {
                str += String.fromCharCode(memory[i]);
                i++;
            }
            
            return str;
        }
        
        // Обработчик кнопки
        document.getElementById('calculate').addEventListener('click', () => {
            if (!Module || !Module._createCalc) {
                document.getElementById('result-f').textContent = 'Модуль не загружен';
                return;
            }
            
            const x = parseInt(document.getElementById('x').value) || 0;
            const y = parseInt(document.getElementById('y').value) || 0;
            
            try {
                // 1. Создаем экземпляр класса Calc
                const calcPtr = Module._createCalc(x);
                console.log('Создан Calc с указателем:', calcPtr);
                
                // 2. Вызываем метод f(y)
                const resultF = Module._calcF(calcPtr, y);
                document.getElementById('result-f').textContent = 
                    `${x} * ${y} = ${resultF}`;
                
                // 3. Вызываем метод g() для получения строки
                const stringPtr = Module._calcG(calcPtr);
                const resultG = readAsciiFromMemory(stringPtr);
                document.getElementById('result-g').textContent = resultG;
                
                // 4. Освобождаем память (удаляем экземпляр класса)
                Module._deleteCalc(calcPtr);
                
            } catch (error) {
                console.error('Ошибка выполнения:', error);
                document.getElementById('result-f').textContent = 'Ошибка';
                document.getElementById('result-g').textContent = 'Ошибка: ' + error.message;
            }
        });
        
        // Инициализируем модуль при загрузке страницы
        window.onload = function() {
            initModule();
            document.getElementById('calculate').disabled = true;
        };
    </script>
</body>
</html>
