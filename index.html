<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Class Demo</title>
</head>
<body>
    <h1>WASM Class Demo</h1>
    
    <div>
        <label for="x">Значение x:</label>
        <input type="number" id="x" value="5">
    </div>
    
    <div>
        <label for="y">Значение y:</label>
        <input type="number" id="y" value="3">
    </div>
    
    <div>
        <button id="calculate">Создать Calc(x) и вызвать методы</button>
    </div>
    
    <div>
        <h3>Результаты:</h3>
        <div>
            <strong>f(y) = x * y:</strong> 
            <span id="result-f">-</span>
        </div>
        <div>
            <strong>g() возвращает строку:</strong> 
            <span id="result-g">-</span>
        </div>
    </div>

    <script>
        // Модуль WASM
        let wasmModule = null;
        let memory = null;
        
        // Загрузка WASM
        async function loadWasm() {
            try {
                const response = await fetch('calc.wasm');
                const bytes = await response.arrayBuffer();
                const wasm = await WebAssembly.instantiate(bytes, {});
                
                wasmModule = wasm.instance.exports;
                memory = wasmModule.memory;
                
                console.log('WASM модуль загружен успешно');
                console.log('Доступные функции:', Object.keys(wasmModule));
            } catch (error) {
                console.error('Ошибка загрузки WASM:', error);
                showError('Ошибка загрузки WASM модуля');
            }
        }
        
        // Функция для чтения строк из памяти WASM
        function readWasmString(pointer) {
            if (!pointer || !memory) return "";
            
            const memoryBytes = new Uint8Array(memory.buffer);
            let result = "";
            let i = pointer;
            
            // Читаем строку до нулевого байта
            while (i < memoryBytes.length && memoryBytes[i] !== 0) {
                result += String.fromCharCode(memoryBytes[i]);
                i++;
            }
            
            return result;
        }
        
        // Функция для отображения ошибки
        function showError(message) {
            document.getElementById('result-f').textContent = 'Ошибка';
            document.getElementById('result-g').textContent = message;
        }
        
        // Обработчик кнопки
        document.getElementById('calculate').addEventListener('click', () => {
            if (!wasmModule) {
                showError('WASM модуль еще не загружен');
                return;
            }
            
            const xInput = document.getElementById('x');
            const yInput = document.getElementById('y');
            
            const x = parseInt(xInput.value) || 0;
            const y = parseInt(yInput.value) || 0;
            
            try {
                // 1. Создаем экземпляр класса Calc
                const calcPtr = wasmModule.createCalc(x);
                
                if (!calcPtr) {
                    showError('Не удалось создать экземпляр класса');
                    return;
                }
                
                console.log('Создан Calc с указателем:', calcPtr);
                
                // 2. Вызываем метод f(y)
                const resultF = wasmModule.calcF(calcPtr, y);
                document.getElementById('result-f').textContent = 
                    `${x} * ${y} = ${resultF}`;
                
                // 3. Вызываем метод g() для получения строки
                const stringPtr = wasmModule.calcG(calcPtr);
                const resultG = readWasmString(stringPtr);
                document.getElementById('result-g').textContent = resultG;
                
                // 4. Освобождаем память (удаляем экземпляр класса)
                wasmModule.deleteCalc(calcPtr);
                
            } catch (error) {
                console.error('Ошибка выполнения:', error);
                showError('Ошибка выполнения: ' + error.message);
            }
        });
        
        // Загружаем модуль при открытии страницы
        loadWasm();
    </script>
</body>
</html>
